> 本文翻译自：https://hackernoon.com/getting-deep-into-ethereum-how-data-is-stored-in-ethereum-e3f669d96033
> 
> 译者：[区块链中文字幕组](https://github.com/BlockchainTranslator/EOS) [小丹](https://github.com/zhuangjun)
> 
> 翻译时间：2018-10-30

----------------------------------------------------


在这篇文章中，我们将深入了解以太坊的数据存储层。我们将介绍区块链“状态”的概念。我们将介绍Patricia 特里结构数据结构背后的理论，并使用Google的leveldb数据库演示以太坊的具体尝试实现。

### 我们在存储层中存储了什么？

首先，我们必须看到我们需要存储的所有东西，以使区块链系统工作。让我们举一个Alice给Bob $10的简单例子。

![][4]

我们在这里可以看到，我们可以通过在其上执行交易来更改状态。

在这里，我们必须跟踪不同人的余额和其他细节（**状态**）以及区块链之间发生的事情的详细信息（**交易**）。不同平台处理不同的方式。在这里，我们将看到比特币和以太坊如何处理这个问题。

### 比特币

比特币的“状态”由其全局的未使用交易输出（UTXO）集合表示。比特币的价值转移是通过交易来实现的。更具体地说，比特币用户可以通过创建交易并将其一个或多个UTXO添加为交易输入来花费他们的一个或多个UTXO。

这种UTXO模型使比特币与以太坊不同。让我们看一些例子来理解差异。

首先，比特币UTXO不能部分花费。如果一个比特币用户花费0.5比特币（使用他们唯一的价值1比特币的UTXO）他们必须显式发送自己0.5比特币作为找零。如果他们不发送自己的变更，他们将把比特币矿工的0.5比特币变更放在他们的交易中。

![][6]

UTXO交易

其次，在最基本的层面上，比特币不会维持用户账户余额。使用比特币，用户只需在任何给定时间点将私钥保存到一个或多个UTXO。 **数字钱包使比特币区块链看起来像是自动存储和组织用户帐户余额等等。不是这种情况。**

![][8]

可视化钱包如何在比特币中工作

比特币中的UTXO系统运行良好，部分原因是数字钱包能够促进与交易相关的大多数任务。包括但不仅限于：

a）处理UTXO

b）存储密钥

c）设定交易费用

d）提供退货变更地址

e）汇总UTXO（显示可用，待定和总余额）

UTXO模型中交易的一个类比是纸币（纸币）。每个帐户通过将钱包（与此地址/钱包相关联）中的账单金额（UTXO）相加来跟踪其拥有的金额。当我们想要花钱时，我们使用一个或多个账单（现有的UTXO），足以支付成本并可能收到一些更改（新的UTXO）。每个账单只能花费一次，因为一旦花费，UTXO就会从池中删除。

总而言之，我们知道：

* 比特币区块链不保留账户余额
* 比特币[钱包持有密钥][9]到UTXO
* 如果包含在交易中，则会花费整个UTXO（在某些情况下，部分收回作为全新UTXO形式的“更改”）

### 以太坊

与上述信息相反，以太坊世界状态能够管理账户余额等。以太坊的状态不是一个抽象的概念。它是以太坊基础层协议的一部分。正如黄皮书所提到的，以太坊是一种基于交易的“状态”机器;可以构建所有基于交易的状态机概念的技术。

让我们从头开始吧。与所有其他区块链一样，以太坊区块链在其自身的成因区块开始生命。从这一点（区块0的创世状态）开始，诸如交易，合同和采矿等活动将不断改变以太坊区块链的状态。在以太坊中，这样的一个例子是帐户余额（存储在状态层），每当与该帐户相关的交易发生时，该帐户余额就会发生变化。

重要的是，帐户余额等数据不会直接存储在以太坊区块链的区块中。只有交易特里结构的根节点哈希，状态特里结构和收据特里结构直接存储在区块链中。这在下图中说明。

![][12]

从上图中，您还会注意到存储特里结构的根节点哈希（保存所有智能合约数据）实际上指向状态特里结构，而状态特里结构又指向区块链。我们将尽快放大并详细介绍所有这些内容。

以太坊中有两种截然不同的数据:永久数据和短暂数据。永久数据的一个例子是交易。交易完全确认后，将记录在交易特里;它永远不会改变。短暂数据的一个例子是特定以太坊帐户地址的余额。帐户地址的余额存储在状态特里结构中，并且每当发生针对该特定帐户的交易时就会更改。有意义的是，永久数据（如开采交易）和短暂数据（如帐户余额）应单独存储。以太坊使用特里结构数据结构来管理数据。

以太坊的记录保存与银行一样。类比是使用ATM /借记卡。银行跟踪每张借记卡的金额，当我们需要花钱时，银行会检查其记录，以确保我们在批准交易前有足够的余额。

### UTXO和Account方法之间的比较

UTXO模型的好处：

* **_可伸缩性_**  - 由于可以同时处理多个UTXO，因此可以实现并行交易并鼓励可扩展性创新。
* **_隐私_**  - 即使比特币不是一个完全匿名的系统，但只要用户为每笔交易使用新地址，UTXO就会提供更高级别的隐私。如果需要增强隐私，可以考虑更复杂的方案，例如环签名。

账户/余额模型的好处：

* **_简单_**  - 以太坊选择了一个更直观的模型，为复杂智能合约的开发人员带来好处，特别是那些需要国家信息或涉及多方的合同。一个示例是智能合约，它跟踪状态以基于它们执行不同的任务。 UTXO的无状态模型会强制交易包含状态信息，这不必要地使合同的设计复杂化。
* **_效率_**  - 除了简单性之外，帐户/余额模型更有效率，因为每个交易只需要验证发送帐户是否有足够的余额来支付交易。

账户/余额模型的一个缺点是接受双重支出攻击。可以通过实现递增的随机数来抵消这种类型的攻击。在以太坊中，每个帐户都有一个公共可见的随机数，每次进行交易时，随机数增加一。这可以防止同一个交易被多次提交。 （注意，这个随机数与以太坊的工作随机数证明不同，后者是一个随机值。）

像计算机体系结构中的大多数东西一样，两种模型都有权衡。一些区块链，特别是Hyperledger，采用UTXO，因为他们可以从比特币区块链衍生的创新中受益。我们将研究基于这两种记录保存模型构建的更多技术。

### 仔细看看以太坊中的特里结构结构

让我们更深入地了解状态，存储和交易尝试。

#### 状态特里结构  - 唯一的

在以太坊中只有一个和一个全局状态。

这个全局状态不断更新。

状态特里结构包含以太坊网络中存在的每个帐户的密钥和值对。

“密钥”是单个160位标识符（以太坊帐户的地址）。

全局状态特里结构中的“值”是通过对以太坊帐户的以下帐户详细信息进行编码（使用递归长度前缀编码（RLP）方法）来创建的：
\-nonce
\-balance
\-storageRoot
\-codeHash

状态特里结构的根节点（在给定时间点的整个状态特里结构的散列）被用作状态特里结构的安全且唯一的标识符;状态特里结构的根节点以加密方式依赖于所有内部状态特里结构数据。

![][14]

State 特里结构（Merkle Patricia 特里结构的leveldb实现）和以太坊块之间的关系

![][16]

State 特里结构  - 状态特里结构的根节点的Keccak-256位散列，存储为给定块中的“stateRoot”值。 stateRoot：'0x8c77785e3e9171715dd34117b047dffe44575c32ede59bde39fbf5dc074f2976';

#### 存储特里结构  - 合同数据存在的地方

存储特里是所有合同数据存在的地方。每个以太坊帐户都有自己的存储空间。存储特里结构的根节点的256位散列作为storageRoot值存储在全局状态特里结构中（我们刚刚讨论过）。

![][18]

#### 交易特里 - 每个块一个

每个以太坊块都有自己独立的交易特里。一个块包含许多交易。块中交易的顺序当然由组装块的矿工决定。交易特里结构中特定交易的路径是通过（RLP编码）交易在块中所在的索引。从未更新过采矿的地块;块中交易的位置永远不会改变。这意味着一旦在块的交易特里结构中找到交易，就可以反复返回相同的路径以检索相同的结果。

![][20]

### 在以太坊中尝试的具体例子

以太坊主要的客户端使用两种不同的数据库软件解决方案来存储他们的尝试。以太坊的Rust客户端Parity使用rocksdb。而以太坊的Go，C ++和Python客户端都使用leveldb。

#### 以太坊和rocksdb

Rocksdb超出了这篇文章的范围。这可能会在以后讨论，但是现在，让我们来探讨4个主要以太坊客户中的3个如何使用leveldb。

#### 以太坊和leveldb

LevelDB是一个开源的谷歌键值存储库，除了其他功能外，还提供对数据的前向和后向迭代，从字符串键到字符串值的有序映射，自定义比较函数和自动压缩。使用开源Google压缩/解压缩库“Snappy”自动压缩数据。虽然Snappy并不瞄准最大压缩，但它的目标是非常高的速度。 Leveldb是一种重要的存储和检索机制，用于管理以太坊网络的状态。因此，leveldb是最流行的以太坊客户端（节点）的依赖，例如go-ethereum，cpp-ethereum和pyethereum。

> 虽然可以在磁盘上完成特里结构数据结构的实现（使用诸如leveldb之类的数据库软件），但重要的是要注意遍历特里结构和简单地查看扁平键/值数据库之间存在差异。

要了解更多信息，我们必须使用适当的Patricia 特里结构库访问leveldb中的数据。为此，我们需要安装以太坊。

这是一个易于学习的教程，用于设置您自己的以太坊专用网络。

[**How To: Create Your Own Private Ethereum Blockchain**
_Dev本周亮点_medium.com] [21]

一旦您建立了以太坊私有网络，您就能够执行交易并探索以太坊的“状态”如何响应网络活动，如交易，合同和采矿。如果您无法安装以太坊专用网络，那没关系。我们将从以太坊专用网络提供代码示例和屏幕截图。

### 分析以太坊数据库

正如我们之前提到的，在以太坊区块链中有许多Merkle Patricia 特里结构s（在每个**区块中引用）：
* 状态特里结构
* 存储特里结构
* 交易特里结构
* 收据特里结构

**_以下部分假设您[_****_安装并配置了您自己的以太网专用网络_**][22]**_，或者您很乐意跟随我们运行一些软件和谈话到以太坊的leveldb数据库._**

要在特定块中引用特定的Merkle Patricia 特里结构，我们需要获取其根哈希作为参考。以下命令允许我们在genesis块中获取状态，交易和接收尝试的根哈希值。

![][23]

![][25]

**注意：**如果您想要**最新**块的根哈希值（而不是genesis块），请使用以下命令。

![][23]

####安装npm，node，level和ethereumjs

我们将使用nodejs，level和[ethereumjs] [26]（在Javascript中实现Ethereum的VM）的组合来检查leveldb数据库。以下命令将进一步准备我们的环境。

![][23]

从这一点开始，运行以下代码将打印以太坊帐户密钥列表（存储在以太坊专用网络的状态根目录中）。代码连接到以太坊的leveldb数据库，进入以太坊的世界状态（使用区块链中块的stateRoot值），然后访问以太坊专用网络上所有帐户的密钥。

![][23]

![][27]

上面的代码输出

> 有趣的是，以太坊中的账户只有在交易发生后才会添加到状态（与该特定账户相关）。例如，仅使用“geth account new”创建新帐户将不包括州特里结构中的该帐户;即使在开采了许多区块之后。但是，如果一个成功的交易（一个Gas花费**和**包含在一个开采的区块中）被记录在该账户上，那么只有那时该账户才会出现在状态特里结构中。这是一个聪明的逻辑，可以防止恶意攻击者不断创建新帐户并使状态特里结构膨胀。

#### 解码数据

您会注意到查询leveldb会返回编码结果。这是因为以太坊在与leveldb交互时使用了自己特别的“Modified Merkle Patricia 特里结构”实现。以太坊Wiki提供了与以太坊[Modified Merkle Patricia 特里结构][28]和[递归长度前缀（RLP）编码][29]的设计和实现相关的信息。简而言之，以太坊已经扩展了特里结构数据结构。例如，Modified Merkle Patricia包含一种方法，该方法可以通过使用“扩展”节点来快速下降（沿着特里）。

在以太坊中，单个修改的Merkle Patricia 特里结构节点是：

* 一个空字符串（称为NULL）
* 包含17个项目的数组（称为分支）
* 包含2个项目的数组（称为叶子）
* 包含2个项目的数组（称为扩展名）

由于以太坊的尝试是用严格的规则设计和构建的，因此检查它们的最佳方法是使用计算机代码。以下示例使用ethereumjs。 ethereumjs存储库易于安装和使用;它们将非常适合我们快速查看以太坊leveldb数据库。

下面的代码（当提供特定块的stateRoot以及以太坊帐户地址时）将以人类可读的形式返回该帐户的正确余额。

![][30]

从以下代码输出（地址为“0xccc6b46fa5606826ce8c18fece6f519064e6130b”的帐户余额）

![][23]

### 结论

我们已经在上面证明了以太坊有能力管理其“状态”。这种巧妙的前期设计具有许多优点。

#### 流动性

鉴于移动设备和物联网（IoT）设备现在无处不在，电子商务的未来取决于安全，强大和快速的移动应用。

![][32]

当我们承认移动性的进步时，我们也承认区块链大小的不断增加是不可避免的。在日常移动设备上存储整个区块链是不切实际的。

#### 速度，不会影响安全性

以太坊的世界状态的设计及其对改良的Merkle Patricia 特里结构的使用在这个领域提供了许多机会。在以太坊中的特里结构上执行的每个功能（放置，更新和删除）都使用确定性加密哈希。此外，特里结根节点的唯一加密散列可以用作特里未被篡改的证据。

例如，对任何级别的特里结构数据的任何更改（例如增加leveldb数据库中的帐户余额）都将完全更改根哈希。此加密功能为轻型客户端（不存储整个区块链的设备）提供了快速可靠地查询区块链的机会，即账户“0x ... 4857”是否有足够的资金在块高“5044866”完成此次购买？

> “Merkle证明的大小复杂度是存储的数据量的对数。这意味着，即使整个状态树的大小为几千兆字节，如果一个节点从一个受信任的源接收一个状态根，该节点具有通过在证明中下载几千字节的数据，能够完全确定地知道树上任何信息的有效性。“

#### 花费限额

以太坊白皮书中提到的一个有趣的想法是储蓄账户的概念。在这种情况下，两个用户（可能是丈夫和妻子，或商业伙伴）每人可以每天提取1％的帐户总余额。这个想法只在白皮书的“进一步的应用程序”部分中提到，但它引起了人们的兴趣，因为理论上它可以作为以太坊基础协议层的一部分实现（因为它必须被写为第二层解决方案或第三方钱包的一部分）。您可能会在本文开头回顾我们关于比特币UTXO的讨论。 UTXO对区块链数据视而不见，正如我们所讨论的，比特币区块链实际上并不存储用户账户余额。出于这个原因，比特币的基本协议层不太可能（或者可能无法）实现任何类型的每日支出限制。

#### 消费者信心

随着这个领域的不断努力，我们将看到轻量级客户的大量发展。更具体地说，安全，强大和快速的移动应用程序，可以与区块链技术交互。

![][34]

在电子商务领域成功实施区块链必须提高速度，安全性和可用性。通过智能设计提供卓越的可用性，安全性和性能，始终有可能提高消费者信心并增加主流采用率。

[1]: https://hackernoon.com/getting-deep-into-geth-why-syncing-ethereum-node-is-slow-1edb04f9dc5 "https://hackernoon.com/getting-deep-into-geth-why-syncing-ethereum-node-is-slow-1edb04f9dc5"
[2]: https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015 "https://hackernoon.com/getting-deep-into-evm-how-ethereum-works-backstage-ac7efa1f0015"
[3]: https://cdn-images-1.medium.com/freeze/max/75/1*fLjE6g-m_YTTXTXqLnpA0w.png?q=20
[4]: https://cdn-images-1.medium.com/max/2000/1*fLjE6g-m_YTTXTXqLnpA0w.png
[5]: https://cdn-images-1.medium.com/freeze/max/75/1*8ckJdAnUMNNd190LNJLz7Q.png?q=20
[6]: https://cdn-images-1.medium.com/max/2000/1*8ckJdAnUMNNd190LNJLz7Q.png
[7]: https://cdn-images-1.medium.com/freeze/max/75/1*0doOO9uDGB3yqfPnsUrAEA.png?q=20
[8]: https://cdn-images-1.medium.com/max/2000/1*0doOO9uDGB3yqfPnsUrAEA.png
[9]: https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch05.asciidoc#wallet-technology-overview
[10]: https://cdn-images-1.medium.com/freeze/max/75/1*f0vOn0lRgrY5NjFlbUMBFg.jpeg?q=20
[11]: https://hackernoon.com/undefined
[12]: https://cdn-images-1.medium.com/max/2000/1*f0vOn0lRgrY5NjFlbUMBFg.jpeg
[13]: https://cdn-images-1.medium.com/freeze/max/75/1*-Q00GpGTphTOtBWPRu1e3g.png?q=20
[14]: https://cdn-images-1.medium.com/max/2000/1*-Q00GpGTphTOtBWPRu1e3g.png
[15]: https://cdn-images-1.medium.com/freeze/max/75/1*NFM4Cb5eJdzJXvj9-dUorg.png?q=20
[16]: https://cdn-images-1.medium.com/max/2000/1*NFM4Cb5eJdzJXvj9-dUorg.png
[17]: https://cdn-images-1.medium.com/freeze/max/75/1*9AvbCSNqn5m9z0qhWjE6cg.png?q=20
[18]: https://cdn-images-1.medium.com/max/2000/1*9AvbCSNqn5m9z0qhWjE6cg.png
[19]: https://cdn-images-1.medium.com/freeze/max/75/1*dWv4-5OQoa52QE03G9Qkwg.png?q=20
[20]: https://cdn-images-1.medium.com/max/2000/1*dWv4-5OQoa52QE03G9Qkwg.png
[21]: https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f "https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f"
[22]: https://medium.com/mercuryprotocol/how-to-create-your-own-private-ethereum-blockchain-dad6af82fc9f
[23]: https://i.embed.ly/1/display/resize?url=https%3A%2F%2Favatars2.githubusercontent.com%2Fu%2F28847087%3Fs%3D400%26v%3D4&key=a19fcc184b9711e1b4764040d3dc5c07&width=40
[24]: https://cdn-images-1.medium.com/freeze/max/75/1*IbnRm4TYAY55u7Ax2ZL_6A.png?q=20
[25]: https://cdn-images-1.medium.com/max/2000/1*IbnRm4TYAY55u7Ax2ZL_6A.png
[26]: https://github.com/ethereumjs/ethereumjs-vm
[27]: https://cdn-images-1.medium.com/max/2000/1*zEIgr2MNmtt_OWGpPe1NJg.png
[28]: https://github.com/ethereum/wiki/wiki/Patricia-Tree
[29]: https://github.com/ethereum/wiki/wiki/RLP
[30]: https://cdn-images-1.medium.com/max/2000/1*xioZ7tF-WJ1cu2XomZjPog.png
[31]: https://cdn-images-1.medium.com/freeze/max/75/1*LUDKKtihxxLFpjz80zf0ag.jpeg?q=20
[32]: https://cdn-images-1.medium.com/max/2000/1*LUDKKtihxxLFpjz80zf0ag.jpeg
[33]: https://cdn-images-1.medium.com/freeze/max/75/1*I-fz7QPeEHWtEk6BKW-rVA.jpeg?q=20
[34]: https://cdn-images-1.medium.com/max/2000/1*I-fz7QPeEHWtEk6BKW-rVA.jpeg




#### 区块链中文字幕组

致力于前沿区块链知识和信息的传播，为中国融入全球区块链世界贡献一份力量。

如果您懂一些技术、懂一些英文，欢迎加入我们，加微信号:w1791520555。

[点击查看项目GITHUB，及更多的译文...](https://github.com/BlockchainTranslator/EOS)

#### 本文译者简介

小丹 区块链技术爱好者  热衷于区块链底层技术研究

版权所有，转载需完整注明以上内容。

----------------------------------------------------